---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import { client, urlFor } from '../../lib/sanity';

export async function getStaticPaths() {
  const projects = await client.fetch(`*[_type == "project"]{ slug }`);
  return projects.map(({ slug }) => {
    return {
      params: { slug: slug.current },
    };
  });
}

const { slug } = Astro.params;

const project = await client.fetch(`*[_type == "project" && slug.current == $slug][0] {
  title,
  description,
  date,
  image,
  gallery,
  link,
  "videoUrl": video.asset->url
}`, { slug });

if (!project) return Astro.redirect('/portfolio/404');
---

<Layout title={`${project.title} - Matheus Melo`}>
	<Header />
	
    <!-- Add top padding to account for fixed header, and min-h-screen -->
	<main class="min-h-screen bg-background pt-24 md:pt-0">
        <div class="flex flex-col md:flex-row min-h-screen">
            
            <!-- Left Column: Scrollable Content (Images & Video) -->
            <div class="w-full md:w-3/5 flex flex-col pt-6 md:pt-24 px-10 md:pl-48 md:pr-16 gap-8 md:gap-16 pb-20 md:pb-32">
                <!-- Main Cover Image -->
                {project.image && (
                    <img 
                        src={urlFor(project.image).width(1200).url()} 
                        alt={project.title} 
                        class="w-full h-auto object-cover"
                    />
                )}

                <!-- Gallery Images -->
                {project.gallery && project.gallery.map(img => (
                    <img 
                        src={urlFor(img).width(1200).url()} 
                        alt={`Gallery image for ${project.title}`} 
                        class="w-full h-auto object-cover"
                    />
                ))}

                <!-- Video (Last Item) -->
                {project.videoUrl && (
                    <div class="w-full mt-4">
                        <video controls class="w-full h-auto" poster={project.image ? urlFor(project.image).width(800).url() : ''}>
                            <source src={project.videoUrl} type="video/mp4" />
                            Seu navegador não suporta a tag de vídeo.
                        </video>
                    </div>
                )}
            </div>

            <!-- Right Column: Sticky Info -->
            <div class="w-full md:w-2/5 md:h-screen md:sticky md:top-0 px-10 md:pr-48 md:pl-16 flex flex-col justify-center pt-10 md:pt-0 pb-20 md:pb-0 bg-background md:bg-transparent z-10">
                 <div class="max-w-xl">
                    <h1 class="font-heading font-light text-3xl md:text-5xl lg:text-6xl leading-[1.1] mb-8 md:mb-12 text-primary">
                        {project.title}
                    </h1>

                    <div class="flex flex-col gap-8 md:gap-12 pl-1">
                        {project.date && (
                             <div class="flex items-center gap-4">
                                <span class="text-[10px] font-sans tracking-[0.2em] text-gray-400 uppercase">Ano</span>
                                <span class="font-sans text-sm md:text-base">{new Date(project.date).getFullYear()}</span>
                             </div>
                        )}

                        <div class="space-y-4">
                            <span class="block text-[10px] font-sans tracking-[0.2em] text-gray-400 uppercase">Sobre</span>
                            <p class="font-sans font-light text-sm md:text-base text-gray-600 leading-relaxed max-w-md whitespace-pre-line">
                                {project.description}
                            </p>
                        </div>

                        {project.link && (
                            <div class="mt-4">
                                <a 
                                    href={project.link} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    class="inline-block border-b border-black pb-1 font-sans text-xs uppercase tracking-widest hover:text-gray-600 hover:border-gray-600 transition-colors"
                                >
                                    Visitar Projeto
                                </a>
                            </div>
                        )}
                    </div>
                 </div>
            </div>

        </div>
	</main>
</Layout>
